<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Restablecer contrase√±a - PlayZone">
    <meta name="theme-color" content="#667eea">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PlayZone">

    <title>Restablecer Contrase√±a - PlayZone</title>

    <link rel="stylesheet" href="/assets/css/login.css">
    <link rel="stylesheet" href="/assets/css/notifications.css">
    <style>
        .password-requirements {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 13px;
        }
        .password-requirements ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }
        .password-requirements li {
            margin: 5px 0;
            color: #666;
        }
        .back-to-login {
            text-align: center;
            margin-top: 20px;
        }
        .back-to-login a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        .back-to-login a:hover {
            text-decoration: underline;
        }
        .error-container {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .password-toggle {
            position: relative;
        }
        .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
            color: #667eea;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="contenedor">
        <h1>Restablecer Contrase√±a</h1>
        <p style="text-align: center; margin-bottom: 20px; color: #666;">
            Ingresa tu nueva contrase√±a
        </p>

        <div id="errorContainer" style="display: none;" class="error-container">
            <strong>‚ö†Ô∏è Error</strong>
            <p id="errorMessage"></p>
        </div>

        <form id="resetPasswordForm">
            <div class="login-form-group password-toggle">
                <label>Nueva Contrase√±a</label>
                <input type="password" id="newPassword" required minlength="6" placeholder="M√≠nimo 6 caracteres">
                <span class="toggle-visibility" onclick="togglePasswordVisibility('newPassword', this)">üëÅÔ∏è</span>
            </div>

            <div class="login-form-group password-toggle">
                <label>Confirmar Contrase√±a</label>
                <input type="password" id="confirmPassword" required minlength="6" placeholder="Repite la contrase√±a">
                <span class="toggle-visibility" onclick="togglePasswordVisibility('confirmPassword', this)">üëÅÔ∏è</span>
            </div>

            <div class="password-requirements">
                <strong>Requisitos de la contrase√±a:</strong>
                <ul>
                    <li>M√≠nimo 6 caracteres</li>
                    <li>Se recomienda usar letras, n√∫meros y s√≠mbolos</li>
                    <li>Ambas contrase√±as deben coincidir</li>
                </ul>
            </div>

            <button type="submit" class="login-btn">Restablecer Contrase√±a</button>
        </form>

        <div class="back-to-login">
            <a href="/login">‚Üê Volver al inicio de sesi√≥n</a>
        </div>
    </div>

    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/notifications.js"></script>
    <script>
        // Obtener token de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Verificar que existe el token
        if (!token) {
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = 'Token de recuperaci√≥n no v√°lido. Por favor solicita un nuevo enlace.';
            document.getElementById('resetPasswordForm').style.display = 'none';
        }

        const resetPasswordForm = document.getElementById('resetPasswordForm');

        // Funci√≥n para alternar visibilidad de contrase√±a
        function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validar que las contrase√±as coincidan
            if (newPassword !== confirmPassword) {
                showNotification('Las contrase√±as no coinciden', 'error');
                return;
            }

            // Validar longitud m√≠nima
            if (newPassword.length < 6) {
                showNotification('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            // Deshabilitar bot√≥n mientras se procesa
            const submitBtn = resetPasswordForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Procesando...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(
                        '‚úÖ Contrase√±a actualizada exitosamente. Redirigiendo al login...',
                        'success'
                    );

                    // Limpiar formulario
                    resetPasswordForm.reset();

                    // Redirigir al login despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showNotification(
                        data.detail || 'Error al restablecer la contrase√±a',
                        'error'
                    );

                    if (response.status === 400) {
                        document.getElementById('errorContainer').style.display = 'block';
                        document.getElementById('errorMessage').textContent =
                            'El token de recuperaci√≥n ha expirado o es inv√°lido. Por favor solicita un nuevo enlace.';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n. Verifica tu internet', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    </script>
</body>
</html>
